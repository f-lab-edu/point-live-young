# ADR-014: 상품 검색 API 필터링 성능 개선을 위한 복합 인덱스 도입 검토

## Status

Rejected

## Context

- 상품 검색 API는 카테고리, 가격대, 브랜드, 평점 등 다양한 필터링 조건과 정렬 옵션을 지원한다.
- 키워드 검색이 아닌 일반 상품 검색 API에서 필터링/정렬을 수행할 때 데이터 셋 50만건 기준 평균 응답 속도는 약 600ms로 측정되었다.
- 더 나은 성능을 기대하고 특정 조건 조합의 속도를 줄이기 위해 복합 인덱스 도입을 검토 했다.

## Decision

- `product` 테이블에 아래와 같이 복합 인덱스를 생성하였다.
```sql
CREATE INDEX idx_product_active_cat_price_name
    ON product (is_deleted, category, price, product_name);
```

**적용 결과**
- 카테고리 + 가격 범위 + 재고 조건 조합에서는 응답 시간이 20ms로 크게 개선되었다.
- 하지만 두 가지 문제가 발생하였다:
1. Full-Text Index와의 충돌
    - 옵티마이저는 하나의 인덱스만 선택할 수 있어 복합 인덱스를 사용하는 쿼리에서는 Full-Text Index를 활용하지 못했다.
    - 이로 인해 키워드 검색 성능이 떨어졌고 FORCE INDEX로 Full-Text Index를 강제 지정하여 해결했다.

2. 실행 계획 문제
    - 다른 조건 조합에서는 응답 시간이 1s 이상으로 오히려 악화되었다.
    - 원인은 실행 계획 문제였다. 옵티마이저가 복합 인덱스를 활용하지 못하여 filesort + full scan이 발생했기 때문이다.

<br/>

**결론**
- 전체적인 API 성능과 운영 복잡성을 고려하여 복합 인덱스 도입을 철회하기로 결정했다.

## Consequences

**추후 고려사항**

- 현재 구조 유지 : 평균 응답 600ms는 충분히 빠르다고 판단
- 패턴별 전용 인덱스 : 특정 자주 사용되는 필터링 조합에 대해서만 단일 칼럼 인덱스를 추가하는 방안을 고려
- 향후 전문 검색 엔진 도입 검토 : Elasticsearch, Solr 등
- 캐시 활용 : Redis, Memcached 등