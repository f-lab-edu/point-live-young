# ADR-007: 요청 단위 식별을 위한 MDC 로깅 적용
---

## Status
---  
Accepted

## Context
---
로그를 분석할 때 같은 요청에서 발생한 로그들을 한눈에 추적하기 어려운 문제가 있었다.
멀티스레드 환경에서 동시에 여러 요청이 처리되면 로그 라인이 섞여서 출력되기 때문에 특정 요청의 흐름을 따라가기 힘들다.

대안
1. Spring Interceptor를 이용하여 컨트롤러 단에서 MDC에 요청 ID 저장
    - MVC 요청에만 적용 가능하고 정적 리소스나 보안 필터 등 서블릿 레벨에서 발생하는 로그는 추적 불가능하다.
2. 서블릿 Filter를 이용하여 요청 시작 시 MDC에 요청 ID 저장
   - DispatcherServlet 앞단에서 실행되므로 모든 요청에 적용 가능하다.
   - 응답이 끝난 후 MDC.clear()로 정리하여 누수 방지를 할 수 있다.
## Decision
---
서블릿 Filter를 사용하여 요청 단위로 고유한 traceId를 MDC에 저장하는 방식을 결정했다.

이유
1. 요청 전 범위 추적 필요
    - Interceptor는 MVC 요청에만 동작하지만 Filter는 정적 리소스, 에러 페이지, 보안 필더 등 더 넓은 범위를 추적할 수 있다.

2. 실행 순서 제어
    - Filter는 @Order(Ordered.HIGHEST_PRECEDENCE)를 통해 체인 최상단에서 실행시킬 수 있어 이후 모든 로깅 컨텍스트에 동일한 traceId를 전파할 수 있다.


## Consequences
---
장점
- 서블릿 레벨에서 적용되어 Spring MVC 외부에서 발생하는 로그도 추적된다.
- 모든 로그 라인에 traceId가 포함되어 요청 단위 추적이 가능하다.

단점
- traceId는 JVM 메모리에만 남아서 분산 환경에서 서비스 간 요청을 추적하려면 추가적으로 분산 트레이싱 솔루션이 필요하다.


추후 고려 사항
- 현재는 단일 서버지만 분산환경이 되면 분산 트레이싱 방법을 통해서 시스템 전반 추적을 할 수 있다.