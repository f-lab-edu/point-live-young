# ADR-016: CI/CD Docker Image 다중 태그 전략 (:latest + :commitSHA)

## Status
Accepted

## Context
- 현재 CI/CD 파이프라인에서 Docker 이미지를 빌드하고 AWS ECR에 push 할때 :latest 태그만 사용하고 있었다.
- 하지만 이 방식은 아래와 같은 문제가 있다.
    - 롤백 불가 : latest 만 존재하면 특정 시점의 안정적인 버전으로 돌아가기 어렵다.
    - 추적 불가 : 배포된 컨테이너가 어떤 커밋에서 빌드된 것인지 알수 없다.
        - 물론 날짜로 추정할 수 있지만 정확하지 않다.
- 그래서 배포 이력 추적과 롤백이 가능한 태그 전략이 필요 했다.

## Decision
- 다중 태그 전략을 채택했다.
- 하나의 이미지를 :latest 태그와 commitSHA 태그를 동시에 붙여서 관리한다.

**방법**
1. GitHub Actions에서 Docker Build 실행
2. 빌드된 이미지를 두 개의 태그로 생성
    - :latest : 최신 배포 버전
    - :commitSHA : 해당 커밋 해시 (예: :a1b2c3d)
3. 두 개의 태그를 모두 AWS ECR에 push
4. 기본 배포는 :latest 태그를 사용하고 문제 발생 시 특정 커밋 태그로 롤백

## Consequences

**장점**
- 항상 :latest 태그로 최신 버전을 배포할 수 있다.
- 특정 커밋 SHA 기반 태그를 통해 어떤 코드가 배포되었는지 추적 가능하다.
- 장애 발생 시 특정 커밋 태그를 지정해서 롤백할 수 있다.

**단점**
- 태그 관리가 늘어나서 ECR 저장소에 이미지가 빠르게 쌓일수 있어 정기적인 정리가 필요하다.
- 운영자가 롤백 시에 직접 커밋 SHA를 지정해야 해서 약간의 수동 작업이 필요하다.

**고려사항**
- ECR Lifecycle Policy를 설정해서 오래된 이미지를 자동으로 삭제하도록 관리할 계획이다.