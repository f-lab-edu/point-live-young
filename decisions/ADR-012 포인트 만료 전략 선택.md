# ADR-012: 포인트 만료 전략 선택


## Status

Accepted

## Context
- 기존 설계에서는 **매분 스케줄러**가 전 사용자 포인트 만료를 처리한다.
- 매분 스케줄링은 트래픽/데이터가 늘어날수록 **주기적 대량 UPDATE로 DB 경합·락·I/O 부하를 유발**하여 전체 서비스 **성능** 에 영향을 줄 수 있다.
- 그리고 사용자 입장에서 조회 시점과 배치 처리 시점 사이의 시차가 미세하게 존재해서 이미 만료되었어야 할 포인트가 화면에 노출되는 현상도 일어날수 있다.

**고려한 대안**
1. 조회시 만료 처리
    - 사용자가 포인트를 조회할 때 해당 유저의 만료된 포인트만 UPDATE 처리하고 최신 상태를 반환한다.
    - **장점**
        - 조회 시점 기준으로 즉시 일관성 있는 최신 상태 제공한다.
        - 배치로 인한 DB 부하를 줄인다.
        - 실패해도 조회는 그대로 진행 가능하다.
        - 구현이 단순하다.
    - **단점**
        - GET 요청에서 UPDATE 처리가 발생하여 RESTful API 설계 원칙에 어긋난다.
        - 트래픽 증가 시 조회 요청이 몰리면 DB 부하가 커질 수 있다.
        - 소량의 포인트일 때는 괜찮지만, 대량의 포인트가 만료될 때는 여러 건의 UPDATE가 발생하여 응답 지연이 발생할 수 있다.
2. 메세지 큐 기반 비동기 처리
    - 포인트 만료 이벤트를 메세지 큐에 적재하고 별도의 컨슈머가 비동기적으로 만료 처리를 담당한다.
    - **장점**
        - API 읽기 요청과 만료 처리 로직이 분리되어 응답 지연이 없다.
        - 대량의 만료 처리를 효율적으로 처리할 수 있다.
        - 장애 발생 시 재시도 및 복구가 용이하다.
    - **단점**
        - 인프라 복잡성 증가 (메세지 큐 도입 및 운영)
        - 이벤트 누락하거나 중복 처리 될 가능성이 있다.
        - 처리 지연시에 사용자에게 최신 상태를 즉시 제공하지 못할 수 있다.
3. TTL(Time-To-Live) 설정
    - Redis 같은 인메모리 데이터 저장소나 TTL을 지원하는 DB를 사용해 포인트 데이터에 TTL을 설정한다.
    - **장점**
        - TTL 설정만으로 자동 만료 처리 가능해서 가장 단순하다.
        - 읽기에서 UPDATE가 발생하지 않는다.
    - **단점**
        - TTL 기능이 없는 DB에서는 적용 불가하다.
        - Redis 같은 인메모리 저장소 사용 시 데이터 영속성 및 일관성 문제 발생할 수 있다. -> 추가 적인 DB 동기화 로직이 필요하다.

## Decision
- 1번 조회시 만료 처리 방식을 채택하기로 결정한다.
- **채택 이유** :
    - 단기적으로는 구현 단순성과 즉각적인 일관성 확보가 가장 중요하기 때문이다.
    - 2번인 메시지 큐 기반은 운영 복잡도가 높아 현 시점에는 부담이 크다고 판단했고
    - 3번인 TTL 설정은 현재 DB에서 지원하지 않아 도입이 어렵다.
    - 현재 시점에서는 소량의 데이터 처리가 예상되어 조회 시 만료 처리가 큰 부하를 유발하지 않을 것으로 기대된다.
- **구현 방법** :
    - `GET /api/user-points` 호출 시:
        1. 해당 유저의 만료 포인트를 UPDATE 처리
        2. UPDATE 처리 도중 에러 발생 시 로깅 하고 기존 포인트 조회는 정상적으로 수행
        3. 최종적으로 유저의 포인트들을 조회후 반환



## Consequences
- **장점**
    - 사용자 화면에서 만료 포인트가 즉시 반영 된다.
    - 매분 대량 스케줄러 부하 제거
    - 가용성 유지 및 로그 기반 추적 가능
- **단점**
    - REST 원칙 위배 (GET에서 UPDATE 발생)
    - 트래픽 증가 시 조회 성능 저하 가능성 존재
- 추후 고려사항
    - UPDATE 처리 실패 시 실패 데이터 적재 및 재처리 체계 구축 고려(알림 등)
    - 데이터/트래픽 증가 시 메세지 큐 기반 비동기 만료 처리로 확장, TTL 지원 DB 도입 고려
    - 모니터링 : 만료 처리 시간, 실패율, 트래픽 대비 응답 시간 등 지표 모니터링

