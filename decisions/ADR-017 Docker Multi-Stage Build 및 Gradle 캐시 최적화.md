# ADR-017: Docker Multi-Stage Build 및 Gradle 캐시 최적화

## Status
Accepted

## Context
- Dockerfile은 단일 스테이지로 작성되어 있다.
- 이 방식은 빌드와 실행 환경이 한 컨테이너에 모두 포함되어 아래와 같은 문제가 있었다.
    - 이미지 크기 증가 : 빌드 도구와 라이브러리가 포함되어 이미지가 커짐.
    - 보안 취약점 : 필요하지 않은 빌드 도구가 포함되어 보안에 위험 요소가 됨.
    - 빌드 속도 저하 : 소스 코드 변경 시 매번 전체 이미지를 다시 빌드해야 함.

## Decision
- Docker Multi-Stage Build를 도입했다.
- 빌드 단계에서는 JDK + Gradle 환경을 사용해 애플리케이션을 빌드한다.
- 런타임 단계에서는 JRE 환경만 포함한 경량 이미지로 애플리케이션을 실행한다.
- Gradle 캐시를 활용해 빌드 속도를 최적화 한다.
    - gradlew, gradle/, vuild.gradle, settings.gradle 파일을 먼저 복사해 의존성 다운로드만 수행.
    - 이후 코드만 변경 될 경우에는 의존성 레이어는 캐시가 재사용되어 재다운로드를 하지 않아 속도가 빨라진다.

**코드**
- [Dockerfile](../../Dockerfile) 참고

## Consequences

**장점**
- 이미지 크기 감소 : 최종 이미지는 실행에 필요한 JAR + JRE 만 포함되어 훨씬 작아진다.
- Gradle 캐시 활용 : 의존성 레이어가 캐시되어 빌드 속도가 크게 향상된다.
- 불필요한 파일 제거 : 빌드 도구와 소스 코드가 최종 이미지에 포함되지 않아 보안과 성능이 개선된다.

**단점**
- Dockerfile 전보다 복잡해진다.
- Gradle 캐시 최적화는 build.gradle이나 의존성 버전이 변경된다고 하면 캐시가 무효화되어 다시 다운로드 해야한다.